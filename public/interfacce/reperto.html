<!DOCTYPE html>


<!--[if IE 8]><html class="no-js lt-ie9" lang="en" ><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" ><!--<![endif]-->

 <head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  <title>Reperto</title>
  

	<!-- Fogli di stile -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
 	<link href="css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="css/museo.css" rel="stylesheet" media="screen">

     <!-- respond.js per IE8 -->
     <!--[if lt IE 9]>
     <script src="js/respond.min.js"></script>
     <![endif]-->
     <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
     <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
     <script src="http://code.jquery.com/jquery.js"></script>

   
  <script>
      var $campi = '';
      function urlParams(name){
          var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
          if (!results) {
              return 0;
          }
          return results[1] || 0;
      };
      function loadCard(){
          if(urlParams('id_codscheda')>0){$.ajax({
              type: "GET",
              url: "/api/museums/getCard",
              data:{auth_token: urlParams('key'), id: urlParams('id_codscheda')},
              dataType: "json",
              success: function(data){
                  //alert(JSON.stringify(data.data[0]));
                  $.each(data.data[0], function (a, campo) {
                      //alert(a);
                      //alert(campo);
                      $('#' + a).val(campo);
                  });

              },
              error: function(){
                  alert("Chiamata fallita, si prega di riprovare...");}
          });
          }

      }

      var a=0

      function slide(i){
          for(var a=0; a==i; a++) {

             // if(i==a) {
                  $('#'+ i ).toggle();
                  break;
              //}
          }
      }


      function getSectionLabel(data, sectionName){
          var sectionLabel = $.unique($.map(data.data, function(item){if(item.museum_section.section_name == sectionName){return item.museum_section.section_label;}}));
          return sectionLabel;
      }
      function getFieldLabel(data, fieldId){
          var fieldLabel = $.unique($.map(data.data, function(item){if(item.field_name == fieldId){return item.label;}}));
          return fieldLabel;
      }

      function getReperto(){$.ajax({
          type: "GET",
          url: "/api/museums/getSectionDetail",
          data:{auth_token: urlParams('key'), catalog: ('default'), section: ('*'),filter:{"enabled_eq":true}},
          dataType: "json",
          success: function(data){
              if(data.error != null){
                  //alert(JSON.stringify(data.error));

              }
              else{
                  //alert(JSON.stringify(data));
                  //alert(JSON.stringify(data.data));
                  var sezioni = $.unique($.map(data.data, function(item){return item.museum_section.section_name}));

                  //alert (JSON.stringify(sezioni));
                  var campi;
                  //var idsezione= $.unique($.map(data.data, function(item){return item.museum_section.museum_section_id}));
                  var fields="";

                  //costruzione html
                  fields += '<p><div class="well well-large">' +
                          '<ul class="media-list">' +
                          '<li class="media">' +
                          '<div class="media-body">' +
                          '<a class="pull-right" href="#">' +
                          '<img src="images/reperto.jpg" class="img img-thumbnail img-responsive">' +
                          '</a>' +
                          '<div style="line-height:20px">' +
                          '&nbsp;' +
                          '</div>'
                  $campi = $.map(data.data, function(item){return item.template_field_id});

                  $.each(sezioni, function (i, sezione) {
                      //per ogni elemento stampo l'html della sezione
                      fields +='<div id="panel"   class="panel-collapse " onclick="slide('+ i +')">' +
                              '<div class="row">' +
                              '<div class="col-sm-5 col-lg-5" style="width: 440px">' +
                              '<div class="row">' +
                              '<span class="label label-sezione flip" id="flip_s1" >' +  getSectionLabel(data,sezione)  + '</span>' +
                              '<div class="sezione_panel" id="'+ i +'">'


                      //prendo l'id della sezione per passarlo all'id dei campi


                      //genero la lista dei campi della sezione
                      campi = $.map(data.data, function(item){if(item.museum_section.section_name==sezione){return item.field_name}});
                      //per ogni elemento stampo l'html del campo
                       $.each(campi, function (a, campo) {
                          //alert(campo);

                          fields +='<span class="testotext">' +  getFieldLabel(data,campo)  + '</span>' +
                                  '<div style="margin-bottom: 25px; margin-top:10px" class="input-group">' +
                                  '<span class="input-group-addon"><i class="glyphicon glyphicon-pencil"></i></span>' +
                                  '<input type="text" class="form-control" style="width: 330px" id="'+ campo +'" placeholder="' +  getFieldLabel(data,campo)  + '">' +
                                  '</div>'

                      });

                      fields += '</div>' +
                                '</div>' +

                                '<br>'

                  });
              }



              fields += '<br>' +
                        '<div class="row">' +
                        '<div class="col-lg-6">' +
                        '<div class="input-group">' +
                        '<button type="button" class="btn btn-primary " onclick="saveCard()">Salva</button>' +
                        '</div>' +<!-- /input-group -->
                        '</div>' +<!-- /.col-lg-6 -->
                        '<div class="col-lg-6" align="right">' +
                        '<button type="button" class="btn btn-primary ">Export</button>&nbsp;' +
                        '<button type="button" class="btn btn-primary ">Print</button>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +//collapse
                        '</li>' +
                        '</ul>' +
                        '</div>'
              $('#reperto').append(fields);
              loadCard();
          },
          error: function(){
              alert("Chiamata fallita, si prega di riprovare...");}
      });
      }

          function saveCard(){
              var cardData = {};
              var listInput = $('input');
              $.each(listInput, function (a, campo) {
                  //alert(campo);
                  cardData[campo.id] = $('#' + campo.id).val() || '';
              });
              //alert(JSON.stringify(cardData));
              /*
              $.ajax({
                  type: "POST",
                  url: "http://127.0.0.1:3000/api/museums/saveCard",
                  data:{"auth_token":urlParams('key'), "id":"", "data":cardData},
                  dataType: "json",
                  success: function(data){//alert(data.error);
                      alert(JSON.stringify(data));
                  },
                  error: function(data){
                      alert("Chiamata fallita, si prega di riprovare...");
                      alert(data.error);
                      alert(JSON.stringify(data));
                  }
              });
              */
          }




      $(document).ready(function(){

  		$("#flip").click(function(){
			$("#panel").slideToggle("slow");
		});

		$("#flip2").click(function(){
			$("#panel2").slideToggle("slow");
		});

		$("#flip3").click(function(){
			$("#panel3").slideToggle("slow");
		});

		$("#flip4").click(function(){
			$("#panel4").slideToggle("slow");
		});

		$("#flip5").click(function(){
			$("#panel5").slideToggle("slow");
		});

		$("#flip6").click(function(){
			$("#panel6").slideToggle("slow");
		});
		$("#flip7").click(function(){$("#panel7").slideToggle("slow");});
		$("#flip8").click(function(){$("#panel8").slideToggle("slow");});
		$("#flip9").click(function(){$("#panel9").slideToggle("slow");});
		$("#flip10").click(function(){$("#panel10").slideToggle("slow");});
		$("#flip11").click(function(){$("#panel11").slideToggle("slow");});

		$("#flip_s1").click(function(){$("#panel_s1").slideToggle("slow");});
		$("#flip_s2").click(function(){$("#panel_s2").slideToggle("slow");});
		$("#flip_s3").click(function(){$("#panel_s3").slideToggle("slow");});

	});
  </script>
<script src="js/search.js"></script>
 <!-- <style type="text/css"> 
		#panel,#flip,#panel2,#flip2,#panel3,#flip3,#panel4,#flip4,#panel5,#flip5,
		#panel6,#flip6,#panel7,#flip7,#panel8,#flip8,#panel9,#flip9,#panel10,#flip10,#panel11,#flip11
		{
		text-align:left;
		background-color:#f5f5f5;
		}
		#panel,#panel2,#panel3,#panel4,#panel5,#panel6,#panel7,#panel8,#panel9,#panel10,#panel11
		{
		display:none;
		}
  </style> -->


 </head>
 <body onload="getReperto()">
 <div class="containermuseum">
 	
    
  	<img src="images/banner.jpg" class="img-responsive">
    <div class="lineb"></div>
	<div class="linec"></div>

    
    <p>	 
    <div class="tabbable"> <!-- Only required for left/right tabs -->
    	<ul class="nav responsive nav-tabs">
    		<li class="active"><a href="#tab1" data-toggle="tab" onclick="getReperto()">Scheda Reperto</a></li>
            <li><a href="#tab2" data-toggle="tab" onclick="renderFieldSearch()">Ricerca Reperto</a></li>
            <li><a href="#tab3" data-toggle="tab">Risultati</a></li>
             
        </ul>
        

     	<div class="col-lg-10">
     	</div>
     	<div class="col-lg-2" style="top:-25px; position:relative"; align="right">
            <a class="testol" href="#" onclick="javascript: location.href='home.html?key='+urlParams('key');"><span class="glyphicon glyphicon-home"></span>&nbsp;Menù</a>
    	</div>

        <div class="tab-content">

    <!--Tab1-->

          <div class="tab-pane active" id="tab1"><p id="reperto"> </p></div>

    <!--Tab1-->
      		
            
      <div class="tab-pane" id="tab2">
        <p> 
            <div class="well well-large">
            	  	
                <div class="form-group" id="searchParameter">

                    <div class="form-group" align="right">
                        <button type="submit" class="btn btn-primary " onclick="getResult()">Avvia Ricerca</button>
                    </div>
                </div> <!-- chiusura form-group -->
            </div>
            
        </p>
      </div><!-- tab2 -->
    		
    		  
    	<div class="tab-pane" id="tab3">
            <p>
            <div class="well well-lg">
                <p>
                    <div class="form-group">
                        <h6><form class="form-horizontal">
                            <div class="form-group" style="size:5px;" id="searchResultCount"></div>
                        </form>
                        </h6>
                    </div>
                </p>
                <p>
                    <div class="form-group" id="searchResultList"></div>
                </p>
            </div>
            </p>
        </div><!-- tab 4 -->
          
    	</div>
    </div>           
    
 	</p>
 <!-- jQuery e plugin JavaScript  -->
 <script src="http://code.jquery.com/jquery.js"></script>
 <script src="js/bootstrap.min.js"></script>

 </div>
 </body>
</html>